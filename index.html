<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lake Shore Driver - Simple Working Version</title>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            overflow: hidden; 
            background: #000;
            font-family: 'Segoe UI', system-ui, sans-serif;
            color: white;
        }

        #game-container { 
            width: 100vw; 
            height: 100vh; 
            position: fixed;
            top: 0; left: 0;
            z-index: 1;
        }

        #hud {
            position: fixed;
            bottom: 30px; left: 50%;
            transform: translateX(-50%);
            z-index: 100;
        }
        
        .hud-item {
            background: rgba(0,0,0,0.8);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 10px;
            padding: 15px 30px;
            text-align: center;
        }
        
        .hud-value {
            color: #00ff88; font-size: 42px; font-weight: bold; 
            font-family: 'Orbitron', sans-serif;
        }
        .hud-label {
            color: #888; font-size: 12px; letter-spacing: 2px; margin-top: 5px;
        }

        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #050510; z-index: 9999;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            font-family: 'Courier New', monospace;
        }
        
        .loader {
            border: 4px solid #333; border-top: 4px solid #00ff88;
            border-radius: 50%; width: 50px; height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #controls-hint {
            position: fixed; top: 20px; right: 20px;
            color: rgba(255,255,255,0.6);
            font-size: 14px; text-align: right;
        }
    </style>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js"
            }
        }
    </script>
</head>
<body>

    <div id="game-container"></div>
    
    <div id="loading-screen">
        <div class="loader"></div>
        <div id="loading-text">LOADING CHICAGO...</div>
    </div>
    
    <div id="controls-hint">
        WASD or Arrow Keys to Drive<br>
        SPACE to Brake
    </div>

    <div id="hud">
        <div class="hud-item">
            <div class="hud-value" id="speed-value">0</div>
            <div class="hud-label">MPH</div>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';

        // --- CONFIG ---
        const START_LAT = 41.9840;
        const START_LON = -87.6530;

        let scene, camera, renderer, car;
        let lastTime = performance.now();
        
        const carState = {
            speed: 0,
            maxSpeed: 300,
            rotation: Math.PI
        };

        const keys = { forward: false, backward: false, left: false, right: false, brake: false };

        // GPS to Local helper
        function gpsToLocal(lat, lon) {
            const z = (START_LAT - lat) * 111132;
            const x = (lon - START_LON) * 82955;
            return new THREE.Vector3(x, 0, z);
        }

        function init() {
            // Scene
            const container = document.getElementById('game-container');
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x050510);
            scene.fog = new THREE.FogExp2(0x050510, 0.002);

            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 30000);
            
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5));
            container.appendChild(renderer.domElement);

            // Lights
            const ambient = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambient);
            const sun = new THREE.DirectionalLight(0xffffff, 1.5);
            sun.position.set(100, 1000, 500);
            scene.add(sun);

            // Simple ground plane (no 3D tiles)
            const groundGeo = new THREE.PlaneGeometry(50000, 50000);
            const groundMat = new THREE.MeshStandardMaterial({ color: 0x1a1a2e });
            const ground = new THREE.Mesh(groundGeo, groundMat);
            ground.rotation.x = -Math.PI / 2;
            ground.position.y = -0.5;
            scene.add(ground);

            // Grid for reference
            const gridHelper = new THREE.GridHelper(50000, 500, 0x00ff88, 0x444444);
            scene.add(gridHelper);

            createCar();
            createTrack();
            setupControls();

            window.addEventListener('resize', onResize);
            
            // Hide loading
            setTimeout(() => {
                document.getElementById('loading-screen').style.opacity = 0;
                setTimeout(() => document.getElementById('loading-screen').remove(), 1000);
            }, 500);

            animate();
        }

        function setupControls() {
            window.addEventListener('keydown', (e) => {
                if(e.code === 'KeyW' || e.code === 'ArrowUp') keys.forward = true;
                if(e.code === 'KeyS' || e.code === 'ArrowDown') keys.backward = true;
                if(e.code === 'KeyA' || e.code === 'ArrowLeft') keys.left = true;
                if(e.code === 'KeyD' || e.code === 'ArrowRight') keys.right = true;
                if(e.code === 'Space') { keys.brake = true; e.preventDefault(); }
            });
            window.addEventListener('keyup', (e) => {
                if(e.code === 'KeyW' || e.code === 'ArrowUp') keys.forward = false;
                if(e.code === 'KeyS' || e.code === 'ArrowDown') keys.backward = false;
                if(e.code === 'KeyA' || e.code === 'ArrowLeft') keys.left = false;
                if(e.code === 'KeyD' || e.code === 'ArrowRight') keys.right = false;
                if(e.code === 'Space') keys.brake = false;
            });
        }

        function createCar() {
            car = new THREE.Group();
            
            // Simple red box car
            const bodyGeo = new THREE.BoxGeometry(2, 0.5, 4.5);
            const bodyMat = new THREE.MeshStandardMaterial({ color: 0xff0000, roughness: 0.2 });
            const mesh = new THREE.Mesh(bodyGeo, bodyMat);
            mesh.position.y = 0.5;
            car.add(mesh);
            
            // Headlights
            const lightL = new THREE.SpotLight(0xffffee, 50, 400, 0.6, 0.5);
            lightL.position.set(-0.8, 1.0, -1.0);
            lightL.target.position.set(-0.8, 0, -50);
            car.add(lightL);
            car.add(lightL.target);

            const lightR = new THREE.SpotLight(0xffffee, 50, 400, 0.6, 0.5);
            lightR.position.set(0.8, 1.0, -1.0);
            lightR.target.position.set(0.8, 0, -50);
            car.add(lightR);
            car.add(lightR.target);

            scene.add(car);
            car.position.set(0, 1, 0);
        }

        function createTrack() {
            // Ramps
            const rampLocations = [
                { lat: 41.9840, lon: -87.6530, color: 0xff6600 },
                { lat: 41.9050, lon: -87.6250, color: 0xff0000 }
            ];

            rampLocations.forEach(data => {
                const pos = gpsToLocal(data.lat, data.lon);
                const geo = new THREE.BoxGeometry(25, 4, 30);
                const mat = new THREE.MeshStandardMaterial({ color: data.color });
                const mesh = new THREE.Mesh(geo, mat);
                mesh.position.set(pos.x, 2, pos.z);
                mesh.rotation.x = -0.2;
                scene.add(mesh);
            });
        }

        function updatePhysics(dt) {
            if (!car) return;

            const speedInc = 80 * dt;
            const turnSpeed = 2.0 * dt;
            const drag = 0.98;
            
            if (keys.forward) carState.speed += speedInc;
            if (keys.backward) carState.speed -= speedInc;
            if (keys.brake) carState.speed *= 0.92;
            carState.speed *= drag;

            if (Math.abs(carState.speed) > 1) {
                if (keys.left) carState.rotation += turnSpeed;
                if (keys.right) carState.rotation -= turnSpeed;
            }

            car.position.x += Math.sin(carState.rotation) * carState.speed * dt;
            car.position.z += Math.cos(carState.rotation) * carState.speed * dt;
            car.rotation.y = carState.rotation;

            // Keep on ground
            car.position.y = 1;

            document.getElementById('speed-value').innerText = Math.abs(Math.round(carState.speed));
        }

        function animate() {
            requestAnimationFrame(animate);
            const now = performance.now();
            const dt = Math.min((now - lastTime) / 1000, 0.1);
            lastTime = now;

            updatePhysics(dt);

            if (car) {
                const offset = new THREE.Vector3(
                    Math.sin(carState.rotation) * -15,
                    5,
                    Math.cos(carState.rotation) * -15
                );
                camera.position.lerp(car.position.clone().add(offset), 0.1);
                camera.lookAt(car.position);
            }
            
            renderer.render(scene, camera);
        }

        function onResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        init();
    </script>
</body>
</html>
